{% extends 'base.html' %}

{% block title %}Record Repayment - Student Loan Portal{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h2 class="display-5 fw-bold text-white">
                    <i class="bi bi-credit-card me-2 text-success"></i>Record Loan Repayment
                </h2>
                <p class="lead text-muted">
                    Record your loan payment to track your repayment progress.
                </p>
            </div>

            <!-- Loan Information Card -->
            <div class="card border-primary mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-info-circle me-2"></i>Loan Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-white">Loan #{{ loan.id }}</h6>
                            <p class="mb-2 text-white">
                                <strong>Amount:</strong> ₹{{ loan.amount }}<br>
                                <strong>Status:</strong> 
                                <span class="badge bg-success">{{ loan.status }}</span><br>
                                <strong>Due Date:</strong> {{ loan.repayment_due_date|date:"F d, Y" }}<br>
                                <strong>Total Due:</strong> ₹{{ loan.total_amount_due|floatformat:2 }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-white">Repayment Status</h6>
                            {% if loan.is_overdue %}
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>OVERDUE!</strong> Please make payment immediately.
                                </div>
                            {% else %}
                                <div class="alert alert-primary">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>{{ loan.days_until_due }} days</strong> until due date
                                </div>
                            {% endif %}
                            
                            <!-- Repayment Progress -->
                            <div class="mb-3">
                                <label class="form-label text-white">Repayment Progress</label>
                                <div class="progress mb-2" style="height: 20px;">
                                    {% widthratio remaining_amount loan.total_amount_due 100 as progress %}
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ progress }}%" 
                                         aria-valuenow="{{ progress }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ progress }}%
                                    </div>
                                </div>
                                <small class="text-muted">
                                    ₹{{ remaining_amount|floatformat:2 }} remaining out of ₹{{ loan.total_amount_due|floatformat:2 }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Repayment Form -->
            <div class="card shadow">
                <div class="card-header" style="background: linear-gradient(135deg, var(--success-color) 0%, #00cc6a 100%);">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-plus-circle me-2"></i>Payment Details
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Amount to Pay -->
                        <div class="mb-4">
                            <label for="{{ form.amount_paid.id_for_label }}" class="form-label">
                                <i class="bi bi-currency-rupee me-1"></i>Amount to Pay (INR) *
                            </label>
                            {{ form.amount_paid }}
                            {% if form.amount_paid.errors %}
                                <div class="text-danger small">{{ form.amount_paid.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Maximum amount you can pay: ₹{{ remaining_amount|floatformat:2 }}
                            </div>
                            
                            <!-- Amount Slider -->
                            <div class="mt-3">
                                <input type="range" class="form-range" id="amountSlider" 
                                       min="0.01" max="{{ remaining_amount }}" value="{{ remaining_amount|floatformat:2 }}" step="0.01">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">₹0.01</small>
                                    <span id="amountDisplay" class="fw-bold text-success">₹{{ remaining_amount|floatformat:2 }}</span>
                                    <small class="text-muted">₹{{ remaining_amount|floatformat:2 }}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <label for="{{ form.payment_method.id_for_label }}" class="form-label">
                                <i class="bi bi-credit-card me-1"></i>Payment Method *
                            </label>
                            {{ form.payment_method }}
                            {% if form.payment_method.errors %}
                                <div class="text-danger small">{{ form.payment_method.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- UPI Details -->
                        <div class="card mb-4" id="upiDetails" style="background: var(--dark-surface-2); display: none;">
                            <div class="card-header">
                                <h6 class="mb-0 text-white">
                                    <i class="bi bi-phone me-2 text-primary"></i>UPI Details
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.upi_id.id_for_label }}" class="form-label">UPI ID *</label>
                                    {{ form.upi_id }}
                                    {% if form.upi_id.errors %}
                                        <div class="text-danger small">{{ form.upi_id.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Enter your UPI ID (e.g., yourname@paytm, yourname@googlepay)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Transfer Details -->
                        <div class="card mb-4" id="bankDetails" style="background: var(--dark-surface-2); display: none;">
                            <div class="card-header">
                                <h6 class="mb-0 text-white">
                                    <i class="bi bi-bank me-2 text-primary"></i>Bank Transfer Details
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.bank_name.id_for_label }}" class="form-label">Bank Name *</label>
                                        {{ form.bank_name }}
                                        {% if form.bank_name.errors %}
                                            <div class="text-danger small">{{ form.bank_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.account_number.id_for_label }}" class="form-label">Account Number *</label>
                                        {{ form.account_number }}
                                        {% if form.account_number.errors %}
                                            <div class="text-danger small">{{ form.account_number.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.ifsc_code.id_for_label }}" class="form-label">IFSC Code *</label>
                                        {{ form.ifsc_code }}
                                        {% if form.ifsc_code.errors %}
                                            <div class="text-danger small">{{ form.ifsc_code.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Transaction ID -->
                        <div class="mb-4">
                            <label for="{{ form.transaction_id.id_for_label }}" class="form-label">
                                <i class="bi bi-receipt me-1"></i>Transaction ID / Reference Number
                            </label>
                            {{ form.transaction_id }}
                            {% if form.transaction_id.errors %}
                                <div class="text-danger small">{{ form.transaction_id.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Optional: Provide transaction ID for payment verification
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                <i class="bi bi-chat-text me-1"></i>Additional Notes
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Optional: Add any additional information about this payment
                            </div>
                        </div>

                        <!-- Payment Summary -->
                        <div class="card mb-4" style="background: var(--dark-surface-2);">
                            <div class="card-body">
                                <h6 class="card-title text-white">
                                    <i class="bi bi-calculator me-2 text-primary"></i>Payment Summary
                                </h6>
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <div class="p-3">
                                            <h6 class="mb-1 text-white">Current Payment</h6>
                                            <span id="currentPayment" class="fw-bold text-success">₹0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="p-3">
                                            <h6 class="mb-1 text-white">Remaining After Payment</h6>
                                            <span id="remainingAfter" class="fw-bold text-warning">₹0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="p-3">
                                            <h6 class="mb-1 text-white">New Progress</h6>
                                            <span id="newProgress" class="fw-bold text-primary">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                <i class="bi bi-check-circle me-2"></i>Record Payment
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Information Cards -->
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <div class="card border-primary h-100">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);">
                            <h6 class="mb-0 text-dark">
                                <i class="bi bi-info-circle me-2"></i>Payment Guidelines
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="bi bi-check text-primary me-2"></i>
                                    <span class="text-white">Payment amount cannot exceed remaining loan amount</span>
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check text-primary me-2"></i>
                                    <span class="text-white">All payments are recorded immediately</span>
                                </li>
                                <li class="mb-0">
                                    <i class="bi bi-check text-primary me-2"></i>
                                    <span class="text-white">Keep transaction receipts for verification</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="card border-warning h-100">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--warning-color) 0%, #e6a600 100%);">
                            <h6 class="mb-0 text-dark">
                                <i class="bi bi-exclamation-triangle me-2"></i>Important Notes
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="bi bi-exclamation text-warning me-2"></i>
                                    <span class="text-white">Ensure payment method is secure</span>
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-exclamation text-warning me-2"></i>
                                    <span class="text-white">Double-check amount before submitting</span>
                                </li>
                                <li class="mb-0">
                                    <i class="bi bi-exclamation text-warning me-2"></i>
                                    <span class="text-white">Contact support if you encounter issues</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Amount slider functionality
    const amountSlider = document.getElementById('amountSlider');
    const amountInput = document.getElementById('id_amount_paid');
    const amountDisplay = document.getElementById('amountDisplay');
    const currentPayment = document.getElementById('currentPayment');
    const remainingAfter = document.getElementById('remainingAfter');
    const newProgress = document.getElementById('newProgress');
    const submitBtn = document.getElementById('submitBtn');
    
    const maxAmount = {{ remaining_amount }};
    const totalAmount = {{ loan.total_amount_due }};

    function updateAmount() {
        const amount = parseFloat(amountSlider.value);
        amountInput.value = amount.toFixed(2);
        amountDisplay.textContent = `₹${amount.toFixed(2)}`;
        
        // Update payment summary
        updatePaymentSummary(amount);
    }

    function updatePaymentSummary(amount) {
        const remaining = maxAmount - amount;
        const progress = ((totalAmount - remaining) / totalAmount) * 100;
        
        currentPayment.textContent = `₹${amount.toFixed(2)}`;
        remainingAfter.textContent = `₹${remaining.toFixed(2)}`;
        newProgress.textContent = `${progress.toFixed(1)}%`;
    }

    // Event listeners
    amountSlider.addEventListener('input', updateAmount);
    amountInput.addEventListener('input', function() {
        const amount = parseFloat(this.value);
        if (amount > 0 && amount <= maxAmount) {
            amountSlider.value = amount;
            updatePaymentSummary(amount);
        }
    });

    // Show/hide payment method specific fields
    const paymentMethod = document.getElementById('id_payment_method');
    const upiDetails = document.getElementById('upiDetails');
    const bankDetails = document.getElementById('bankDetails');
    const upiIdField = document.getElementById('id_upi_id');
    const bankNameField = document.getElementById('id_bank_name');
    const accountNumberField = document.getElementById('id_account_number');
    const ifscCodeField = document.getElementById('id_ifsc_code');

    function togglePaymentMethodFields() {
        // Hide all method-specific fields first
        upiDetails.style.display = 'none';
        bankDetails.style.display = 'none';
        
        // Reset required attributes
        upiIdField.required = false;
        bankNameField.required = false;
        accountNumberField.required = false;
        ifscCodeField.required = false;
        
        // Show relevant fields based on payment method
        if (paymentMethod.value === 'UPI') {
            upiDetails.style.display = 'block';
            upiIdField.required = true;
        } else if (paymentMethod.value === 'Bank Transfer') {
            bankDetails.style.display = 'block';
            bankNameField.required = true;
            accountNumberField.required = true;
            ifscCodeField.required = true;
        }
    }

    paymentMethod.addEventListener('change', togglePaymentMethodFields);
    
    // Initial setup
    updateAmount();
    togglePaymentMethodFields();

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const amount = parseFloat(amountInput.value);
        
        if (amount <= 0) {
            e.preventDefault();
            alert('Please enter a valid payment amount.');
            return false;
        }
        
        if (amount > maxAmount) {
            e.preventDefault();
            alert(`Payment amount cannot exceed remaining loan amount (₹${maxAmount.toFixed(2)}).`);
            return false;
        }
        
        // Disable submit button to prevent double submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
    });
</script>
{% endblock %}
