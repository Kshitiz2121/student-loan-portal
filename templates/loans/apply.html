{% extends 'base.html' %}

{% block title %}Apply for Loan - Student Loan Portal{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h2 class="display-5 fw-bold text-white">
                    <i class="bi bi-plus-circle me-2 text-primary"></i>Apply for Student Loan
                </h2>
                <p class="lead text-muted">
                    Complete the form below to apply for a student loan. Make sure all information is accurate.
                </p>
            </div>

            <!-- Eligibility Check -->
            {% if not user.is_eligible_for_loan %}
                <div class="alert alert-warning" role="alert">
                    <h5 class="alert-heading">
                        <i class="bi bi-exclamation-triangle me-2"></i>Not Eligible for Loan
                    </h5>
                    <p class="mb-0">
                        Your current GPA is {{ user.gpa }}, which is below the minimum requirement of 6.0. 
                        Please improve your academic performance to become eligible for student loans.
                    </p>
                </div>
            {% elif user.has_active_loan %}
                <div class="alert alert-info" role="alert">
                    <h5 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i>Active Loan Exists
                    </h5>
                    <p class="mb-0">
                        You currently have an active loan. Please complete the repayment before applying for a new one.
                        <a href="{% url 'users:dashboard' %}" class="alert-link">View your dashboard</a> for more details.
                    </p>
                </div>
            {% else %}
                <!-- Loan Application Form -->
                <div class="card shadow">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);">
                        <h5 class="mb-0 text-dark">
                            <i class="bi bi-file-earmark-text me-2"></i>Loan Application Form
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form method="post">
                            {% csrf_token %}
                            
                            <!-- Student Information Display -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-white">Student Name</label>
                                    <p class="form-control-plaintext text-muted">{{ user.get_full_name }}</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-white">Student ID</label>
                                    <p class="form-control-plaintext text-muted">{{ user.student_id }}</p>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-white" for="id_university">University</label>
                                    {{ form.university }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-white">GPA</label>
                                    <p class="form-control-plaintext text-muted">
                                        {{ user.gpa }}
                                        {% if user.is_eligible_for_loan %}
                                            <span class="badge bg-success ms-2">Eligible</span>
                                        {% else %}
                                            <span class="badge bg-warning ms-2">Below 6.0</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Loan Amount -->
                            <div class="mb-4">
                                <label for="{{ form.amount.id_for_label }}" class="form-label">
                                    <i class="bi bi-currency-rupee me-1"></i>Loan Amount (INR) *
                                </label>
                                {{ form.amount }}
                                {% if form.amount.errors %}
                                    <div class="text-danger small">{{ form.amount.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Amount must be between ₹500 and ₹100,000. Use the slider below to adjust.
                                </div>
                                
                                <!-- Amount Slider -->
                                <div class="mt-3">
                                    <input type="range" class="form-range" id="amountSlider" 
                                           min="500" max="100000" value="2500" step="100">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">₹500</small>
                                        <span id="amountDisplay" class="fw-bold text-primary">₹2,500</span>
                                        <small class="text-muted">₹100,000</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Loan Reason -->
                            <div class="mb-4">
                                <label for="{{ form.reason.id_for_label }}" class="form-label">
                                    <i class="bi bi-chat-text me-1"></i>Reason for Loan *
                                </label>
                                {{ form.reason }}
                                {% if form.reason.errors %}
                                    <div class="text-danger small">{{ form.reason.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    Please provide a detailed explanation of why you need this loan.
                                </div>
                            </div>

                            <!-- Repayment Due Date -->
                            <div class="mb-4">
                                <label for="{{ form.repayment_due_date.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-event me-1"></i>Preferred Repayment Due Date
                                </label>
                                {{ form.repayment_due_date }}
                                {% if form.repayment_due_date.errors %}
                                    <div class="text-danger small">{{ form.repayment_due_date.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    If not specified, will be set to 12 months from approval date.
                                </div>
                            </div>

                            <!-- Loan Calculator -->
                            <div class="card mb-4" style="background: var(--dark-surface-2);">
                                <div class="card-body">
                                    <h6 class="card-title text-white">
                                        <i class="bi bi-calculator me-2 text-primary"></i>Loan Calculator
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4 text-center">
                                            <div class="p-3">
                                                <h6 class="mb-1 text-white">Principal Amount</h6>
                                                <span id="principalAmount" class="fw-bold text-primary">₹0</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="p-3">
                                                <h6 class="mb-1 text-white">Interest (10% per month)</h6>
                                                <span id="interestAmount" class="fw-bold text-warning">₹0</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="p-3">
                                                <h6 class="mb-1 text-white">Total Amount Due</h6>
                                                <span id="totalAmount" class="fw-bold text-success">₹0</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Months: <span id="monthsDisplay" class="fw-bold text-white">0</span> • Monthly payment: <span id="monthlyPayment" class="fw-bold text-white">₹0</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Terms and Conditions -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="terms" required>
                                    <label class="form-check-label text-white" for="terms">
                                        I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal" class="text-primary">Terms and Conditions</a> 
                                        and understand that this is a binding loan agreement.
                                    </label>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="bi bi-send me-2"></i>Submit Loan Application
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Information Cards -->
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-header" style="background: linear-gradient(135deg, var(--success-color) 0%, #00cc6a 100%);">
                                <h6 class="mb-0 text-dark">
                                    <i class="bi bi-check-circle me-2"></i>Eligibility Confirmed
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="bi bi-check text-success me-2"></i>
                                        <span class="text-white">GPA requirement met ({{ user.gpa }} ≥ 6.0)</span>
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check text-success me-2"></i>
                                        <span class="text-white">No active loans</span>
                                    </li>
                                    <li class="mb-0">
                                        <i class="bi bi-check text-success me-2"></i>
                                        <span class="text-white">Student verification complete</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card border-primary h-100">
                            <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);">
                                <h6 class="mb-0 text-dark">
                                    <i class="bi bi-info-circle me-2"></i>What Happens Next?
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="bi bi-1-circle text-primary me-2"></i>
                                        <span class="text-white">Submit your application</span>
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-2-circle text-primary me-2"></i>
                                        <span class="text-white">Instant approval (if eligible)</span>
                                    </li>
                                    <li class="mb-0">
                                        <i class="bi bi-3-circle text-primary me-2"></i>
                                        <span class="text-white">Receive loan confirmation</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Loan Terms and Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Student Loan Agreement Terms</h6>
                <p>By submitting this loan application, you agree to the following terms:</p>
                <ul>
                    <li><strong>Loan Amount:</strong> ₹500 - ₹100,000 INR</li>
                    <li><strong>Interest Rate:</strong> 10% per month (simple interest)</li>
                    <li><strong>Repayment Period:</strong> Typically 12 months (or as per due date)</li>
                    <li><strong>Repayment Schedule:</strong> Monthly installments</li>
                    <li><strong>Late Fees:</strong> ₹50 per day after due date</li>
                    <li><strong>Default:</strong> After 30 days of non-payment</li>
                </ul>
                
                <h6>Your Responsibilities</h6>
                <ul>
                    <li>Maintain current student status</li>
                    <li>Make timely repayments</li>
                    <li>Notify us of any changes in contact information</li>
                    <li>Keep your account information secure</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Amount slider functionality
    const amountSlider = document.getElementById('amountSlider');
    const amountInput = document.getElementById('id_amount');
    const amountDisplay = document.getElementById('amountDisplay');
    const principalAmount = document.getElementById('principalAmount');
    const interestAmount = document.getElementById('interestAmount');
    const totalAmount = document.getElementById('totalAmount');
    const monthlyPayment = document.getElementById('monthlyPayment');
    const submitBtn = document.getElementById('submitBtn');

    function updateAmount() {
        const amount = parseInt(amountSlider.value);
        amountInput.value = amount;
        amountDisplay.textContent = `₹${amount.toLocaleString()}`;
        
        // Update calculator
        updateCalculator(amount);
    }

    function monthsBetween(startDate, endDate) {
        const s = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
        const e = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
        let months = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth());
        if (e.getDate() > s.getDate()) months += 1; // count partial as full
        return Math.max(1, months);
    }

    function updateCalculator(amount) {
        const monthlyRate = 0.10; // 10% per month simple interest
        // Determine months from today to selected due date; default to 12
        const dueInput = document.getElementById('id_repayment_due_date');
        let months = 12;
        if (dueInput && dueInput.value) {
            const parts = dueInput.value.split('-'); // yyyy-mm-dd
            if (parts.length === 3) {
                const y = parseInt(parts[0], 10);
                const m = parseInt(parts[1], 10) - 1;
                const d = parseInt(parts[2], 10);
                const end = new Date(y, m, d);
                months = monthsBetween(new Date(), end);
            }
        }
        const interest = amount * monthlyRate * months;
        const total = amount + interest;
        const monthly = total / months;
        principalAmount.textContent = `₹${amount.toLocaleString()}`;
        interestAmount.textContent = `₹${interest.toFixed(2)}`;
        totalAmount.textContent = `₹${total.toFixed(2)}`;
        monthlyPayment.textContent = `₹${monthly.toFixed(2)}`;
        const monthsDisplay = document.getElementById('monthsDisplay');
        if (monthsDisplay) monthsDisplay.textContent = months.toString();
    }

    // Event listeners
    amountSlider.addEventListener('input', updateAmount);
    amountInput.addEventListener('input', function() {
        const amount = parseInt(this.value);
        if (amount >= 500 && amount <= 5000) {
            amountSlider.value = amount;
            updateCalculator(amount);
        }
    });

    // Recalculate when due date changes
    const dueInput = document.getElementById('id_repayment_due_date');
    if (dueInput) {
        dueInput.addEventListener('change', function() {
            const amount = parseInt(amountInput.value || amountSlider.value);
            if (!isNaN(amount)) updateCalculator(amount);
        });
    }

    // Initial calculation
    updateAmount();

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const terms = document.getElementById('terms');
        if (!terms.checked) {
            e.preventDefault();
            alert('Please agree to the terms and conditions before submitting.');
            return false;
        }
        
        // Disable submit button to prevent double submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
    });
</script>
{% endblock %}
